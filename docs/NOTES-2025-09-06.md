2025-09-06 Initial Architecture and Technology Selection Notes
------------------------------------------------------------

Summary
- Project name: fast (binary also named fast).
- Goal: Fast, robust, and scalable local AI assistant, CLI first, TUI later.
- Layering: core (core) / fast (CLI) / tui (interface) / providers (adapters, can be split later).

Version Strategy (Current)
- Rust toolchain: stable (see rust-toolchain.toml), with rustfmt/clippy.
- MSRV (Minimum Supported Rust Version): 1.75 (declared in each crate's Cargo.toml).
- Dependencies (TUI): ratatui 0.29, crossterm 0.29, anyhow 1.

Directory Structure (Workspace Planning)
- crates/core        Core logic (conversations, AI abstractions, tools, config, errors)
- crates/fast        Binary entry (subcommands: ask/chat/tools/config/sessions)
- crates/tui         Ratatui interface (second stage)
- crates/providers   Provider adapter collection (can be placed in core/providers module first, split later)
- docs/              Design, decision and research notes (UTF-8, avoid Windows console garbled text)

Key Abstractions
- AiClient/Completer: Unified streaming/non-streaming completion; capability detection (streaming/tools).
- Tool: Name/description/parameter Schema (schemars), run(args, ctx) returns structured results.
- Conversation/Message: Conversation and message models, containing provider/model/metadata (token, duration).
- ConversationStore: Conversation list/create/load/save/append/trim (based on token budget).
- Config: Multi-source configuration merge (default->global->project->environment->CLI), sensitive information masking.

Open Source Component Selection
- CLI/Arguments: clap v4 (clap_derive, clap_complete).
- Async: tokio (rt-multi-thread, macros, signal), futures.
- Network/Streaming: reqwest (rustls) + reqwest-eventsource + reqwest-middleware/reqwest-retry + backoff.
- TUI: ratatui + crossterm; input can use tui-textarea or self-implement; unicode-width handles wide characters.
- Provider:
  - OpenAI: async-openai (mature, function calls + streaming complete).
  - Ollama: REST (reqwest) or third-party library (quality varies, suggest self-wrapping).
  - Gemini: Suggest using reqwest direct connection, adapt SSE/streaming differences.
- Configuration: figment or config; paths: directories; keys: keyring (fallback env/config).
- Storage: Files first (JSON/JSONL), later rusqlite/sqlx-sqlite; serialization: serde/serde_json.
- Tool validation: schemars + jsonschema; sandbox: cap-std + path normalization (dunce/path-absolutize).
- Logging/Errors: tracing + tracing-subscriber (env filter); errors: thiserror + anyhow/miette (application layer).
- Text processing: pulldown-cmark (parsing), syntect (optional highlighting), textwrap (wrapping).
- Token estimation: tiktoken-rs (optional feature, avoid strong binding).
- Testing: insta (snapshots), assert_cmd (CLI), tempfile, proptest (optional).
- Rate limiting & stability: governor (token bucket), tokio-util CancellationToken (cancellation).

CLI Subcommands (Initial)
- fast ask "question"             Single-turn Q&A; supports --model, --no-stream, --provider.
- fast chat                      Multi-turn interaction (non-TUI), history/retry/cancel, pipe-friendly.
- fast tools run <tool> --args   Run tools, output JSON; default only enables whitelist tools.
- fast sessions [list|create|use|delete]  Session management (ID/name).
- fast config [get|set|path]     Configuration management (API Key/model/network/log level).

TUI Key Points (Second Stage)
- Event loop: tokio + mpsc, AI streaming through channels for incremental rendering, support Stop/Cancel.
- Components: chat area, input box, sidebar (sessions/config); scroll and pagination performance first.
- Markdown rendering postponed; prioritize ensuring large text performance and Chinese wide character display correctness.
- Windows/Chinese input method compatibility testing; theme/colors configurable.

Tools & Security
- file_read (read-only sandbox, root directory restriction, prevent path traversal).
- web_fetch (shared reqwest client, timeout/proxy/retry; default disabled needs explicit enabling).
- Parameter JSON Schema validation; tool declarations exposed to AiClient for function-calling.

Configuration & Keys
- Hierarchy: default -> ~/.config/fast/config.toml -> ./.fast/config.toml -> environment variables -> CLI parameters.
- Keys prefer OS Keyring, fallback env/config; mask sensitive fields when printing configuration.

Storage Strategy
- MVP: One directory per session (metadata.json + messages.jsonl).
- Upgrade: rusqlite/sqlx, support indexing/pagination; import/export and migration tools.

Logging & Errors
- tracing: Console concise, file write to user cache directory (rolling logs).
- Errors: User-friendly information + debug details (miette optional).

Tokens & Context
- Estimate tokens based on model; trim historical messages by budget (prioritize keeping recent and important segments).
- Keep code blocks intact; summarize compression when necessary (future optimization point).

Testing Strategy
- core: AiClient mock, Tool parameter boundaries, Store persistence cases.
- CLI: assert_cmd scenario testing (ask/chat/sessions/config).
- TUI: Frame snapshots/layout and scrolling; large text benchmarks.

Milestones
- M0: Skeleton and abstractions (core/fast), mock provider, fast ask minimal runnable.
- M1: Streaming and cancellation (chat_stream), exit/error/retry improvements.
- M2: Session persistence and tools (file_read/web_fetch), jsonschema validation.
- M3: Provider integration (async-openai priority), capability detection and parameterization.
- M4: TUI minimal version (input/output/sidebar).
- M5: Polish and documentation/UTF-8 unification, Windows specific testing.

Risks & Countermeasures
- SSE/streaming format differences: Adapter layer absorbs, unified as Chunk abstraction.
- Large text rendering performance: Pagination/virtualization, on-demand rendering; avoid one-time concatenation.
- Path and network security: cap-std sandbox, domain whitelist, strict timeout and retry limits.
- Windows encoding: All documents use UTF-8; console test Chinese/colors/key combinations.

Notes
- Current todo.txt appears garbled characters, suggest uniformly changing to UTF-8 encoding for saving.
